# 要件文書

## 概要

「魔性の薔薇」の世界観を持つSRPGにおける経験値・レベルアップシステムの実装。プレイヤーキャラクターが戦闘中の様々な行動を通じて経験値を獲得し、レベルアップによって能力値が成長するシステムを構築する。

## 要件

### 要件1: 多様な経験値獲得システム

**ユーザーストーリー:** プレイヤーとして、戦闘中の様々な行動で経験値を獲得したい。単純な撃破だけでなく、攻撃命中や味方支援でも成長を実感したい。

#### 受入基準

1. WHEN プレイヤーキャラクターが敵に攻撃を命中させた THEN システムは攻撃命中経験値を付与する SHALL
2. WHEN プレイヤーキャラクターが敵を撃破した THEN システムは撃破経験値を付与する SHALL  
3. WHEN プレイヤーキャラクターが味方を回復・支援した THEN システムは支援経験値を付与する SHALL
4. WHEN 経験値を獲得した THEN システムは獲得量を視覚的に表示する SHALL
5. WHEN 複数の経験値獲得条件を同時に満たした THEN システムは適切に経験値を累積する SHALL

### 要件2: レベルアップ処理システム

**ユーザーストーリー:** プレイヤーとして、キャラクターがレベルアップした時に明確な成長を感じたい。能力値の上昇を確認し、キャラクターの強化を実感したい。

#### 受入基準

1. WHEN キャラクターの経験値が必要経験値に達した THEN システムはレベルアップを実行する SHALL
2. WHEN レベルアップが発生した THEN システムは能力値成長を計算・適用する SHALL
3. WHEN レベルアップが発生した THEN システムはレベルアップ演出を表示する SHALL
4. WHEN レベルアップ演出中 THEN システムは成長した能力値を表示する SHALL
5. WHEN レベルアップが完了した THEN システムは次のレベルまでの必要経験値を更新する SHALL

### 要件3: 能力値成長システム

**ユーザーストーリー:** プレイヤーとして、キャラクターの能力値成長にランダム性と個性を感じたい。同じキャラクターでも毎回異なる成長パターンを楽しみたい。

#### 受入基準

1. WHEN レベルアップが発生した THEN システムは各能力値の成長率に基づいて成長判定を行う SHALL
2. WHEN 能力値成長判定を行う THEN システムはキャラクター固有の成長率を参照する SHALL
3. WHEN 能力値が成長した THEN システムは能力値上限を超えないよう制限する SHALL
4. WHEN 能力値成長が完了した THEN システムは現在HP/MPを新しい最大値に比例調整する SHALL
5. WHEN 成長結果を表示する THEN システムは上昇した能力値をハイライト表示する SHALL

### 要件4: 経験値テーブル管理システム

**ユーザーストーリー:** 開発者として、レベルアップに必要な経験値や獲得経験値量を外部データで管理したい。バランス調整を容易に行いたい。

#### 受入基準

1. WHEN システムが初期化される THEN 経験値テーブルをJSONファイルから読み込む SHALL
2. WHEN レベルアップ判定を行う THEN システムは経験値テーブルから必要経験値を参照する SHALL
3. WHEN 経験値を付与する THEN システムは経験値テーブルから獲得量を参照する SHALL
4. WHEN 経験値テーブルが不正 THEN システムはエラーを報告しデフォルト値を使用する SHALL
5. WHEN 最大レベルに達した THEN システムは経験値獲得を停止する SHALL

### 要件5: 戦闘システム統合

**ユーザーストーリー:** プレイヤーとして、戦闘中の行動が即座に経験値獲得に反映されることを期待する。戦闘フローを中断することなく経験値システムが動作してほしい。

#### 受入基準

1. WHEN 戦闘で攻撃が命中した THEN システムは戦闘フローを中断せずに経験値を付与する SHALL
2. WHEN 戦闘で敵を撃破した THEN システムは撃破経験値を即座に付与する SHALL
3. WHEN 戦闘で支援行動を実行した THEN システムは支援経験値を付与する SHALL
4. WHEN 戦闘中にレベルアップが発生した THEN システムは戦闘終了後に演出を表示する SHALL
5. WHEN レベルアップで能力値が上昇した THEN システムは戦闘中の現在値を即座に更新する SHALL

### 要件6: UI・視覚フィードバックシステム

**ユーザーストーリー:** プレイヤーとして、経験値獲得やレベルアップを視覚的に確認したい。現在の経験値状況や成長結果を分かりやすく表示してほしい。

#### 受入基準

1. WHEN 経験値を獲得した THEN システムは獲得量をポップアップ表示する SHALL
2. WHEN キャラクター情報を表示する THEN システムは現在経験値と次レベルまでの必要経験値を表示する SHALL
3. WHEN レベルアップが発生した THEN システムはレベルアップエフェクトを表示する SHALL
4. WHEN レベルアップ結果を表示する THEN システムは成長前後の能力値を比較表示する SHALL
5. WHEN 経験値バーを表示する THEN システムは現在の経験値進捗を視覚的に表現する SHALL

### 要件7: データ永続化・セーブシステム統合

**ユーザーストーリー:** プレイヤーとして、キャラクターの経験値とレベルがゲーム終了後も保持されることを期待する。章を跨いでキャラクターの成長が継続してほしい。

#### 受入基準

1. WHEN ゲームを保存する THEN システムは全キャラクターの経験値・レベル情報を保存する SHALL
2. WHEN ゲームを読み込む THEN システムは保存された経験値・レベル情報を復元する SHALL
3. WHEN 章を完了する THEN システムはキャラクターの成長情報を次章に引き継ぐ SHALL
4. WHEN セーブデータが破損している THEN システムはエラーを報告し初期値で復旧する SHALL
5. WHEN 新しいキャラクターが仲間になる THEN システムは適切な初期レベル・経験値を設定する SHALL

### 要件8: パフォーマンス・最適化

**ユーザーストーリー:** プレイヤーとして、経験値計算やレベルアップ処理が快適に動作することを期待する。戦闘中の処理遅延を感じたくない。

#### 受入基準

1. WHEN 経験値計算を実行する THEN システムは100ms以内に処理を完了する SHALL
2. WHEN レベルアップ処理を実行する THEN システムは200ms以内に処理を完了する SHALL
3. WHEN 複数キャラクターが同時に経験値を獲得する THEN システムは効率的に一括処理する SHALL
4. WHEN 経験値テーブルを参照する THEN システムはキャッシュを活用して高速化する SHALL
5. WHEN メモリ使用量を監視する THEN システムは経験値関連データのメモリリークを防ぐ SHALL
