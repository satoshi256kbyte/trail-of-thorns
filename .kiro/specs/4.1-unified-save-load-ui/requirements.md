# 統合セーブ・ロードUI システム要件定義

## 1. 概要

### 1.1 目的

既に実装済みの`SaveLoadManager`を活用し、プレイヤーがゲーム進行状況を保存・読み込みできる統一されたUIシステムを提供します。

### 1.2 スコープ

- **実装対象**: セーブ・ロードUI画面のみ
- **実装済み**: `SaveLoadManager`による保存・読み込み機能、LocalStorage連携
- **対象外**: セーブデータの永続化ロジック（既に実装済み）

### 1.3 前提条件

- `SaveLoadManager`が完全に実装済み
- 10個のセーブスロット（スロット0はオートセーブ専用）
- LocalStorageへの保存・読み込みが動作済み
- セーブデータ検証機能が実装済み

## 2. 機能要件

### 2.1 セーブスロット一覧表示

**要件ID**: REQ-4.1-001

**EARS形式**:

- **UBIQUITOUS**: システムは、セーブ・ロード画面を開いたとき、10個のセーブスロット（スロット0-9）を一覧表示しなければならない
- **UBIQUITOUS**: システムは、各セーブスロットについて、以下の情報を表示しなければならない：
  - スロット番号
  - セーブデータの有無（空スロット/データあり）
  - 最終保存日時（データがある場合）
  - 章名（データがある場合）
  - 現在のステージ名（データがある場合）
  - プレイ時間（データがある場合）
- **UBIQUITOUS**: システムは、スロット0を「オートセーブ」として特別に表示しなければならない
- **UBIQUITOUS**: システムは、空のセーブスロットを「空きスロット」として明示的に表示しなければならない

**受け入れ基準**:

- [ ] 10個のセーブスロットが縦または横に並んで表示される
- [ ] スロット0が「オートセーブ」として識別可能
- [ ] 各スロットの情報が読みやすく整理されている
- [ ] 空スロットとデータありスロットが視覚的に区別できる

### 2.2 セーブデータ詳細情報表示

**要件ID**: REQ-4.1-002

**EARS形式**:

- **EVENT-DRIVEN**: セーブスロットにカーソルを合わせたとき、システムは詳細情報パネルを表示しなければならない
- **UBIQUITOUS**: 詳細情報パネルには、以下の情報を含めなければならない：
  - 章名とステージ名
  - 推奨レベル
  - プレイ時間（時:分:秒形式）
  - 最終保存日時（年/月/日 時:分形式）
  - パーティ編成（キャラクター名リスト）
  - 完了済みステージ数
- **OPTIONAL**: セーブデータが破損している場合、システムは「データ破損」警告を表示してもよい

**受け入れ基準**:

- [ ] スロットにカーソルを合わせると詳細パネルが表示される
- [ ] 詳細情報が見やすく整理されている
- [ ] 破損データの場合は警告が表示される
- [ ] 空スロットの場合は「データなし」と表示される

### 2.3 セーブ実行機能

**要件ID**: REQ-4.1-003

**EARS形式**:

- **EVENT-DRIVEN**: プレイヤーがセーブスロットを選択して「保存」ボタンを押したとき、システムは現在のゲーム状態を選択したスロットに保存しなければならない
- **EVENT-DRIVEN**: 既にデータが存在するスロットに保存しようとしたとき、システムは上書き確認ダイアログを表示しなければならない
- **UBIQUITOUS**: 上書き確認ダイアログには、「はい」「いいえ」の選択肢を表示しなければならない
- **EVENT-DRIVEN**: 保存が成功したとき、システムは「保存完了」メッセージを表示しなければならない
- **EVENT-DRIVEN**: 保存が失敗したとき、システムは「保存失敗」エラーメッセージを表示しなければならない
- **UNWANTED**: システムは、スロット0（オートセーブ専用）への手動保存を許可してはならない

**受け入れ基準**:

- [ ] セーブスロット選択→保存ボタンでセーブが実行される
- [ ] 既存データがある場合は上書き確認が表示される
- [ ] 保存成功時に成功メッセージが表示される
- [ ] 保存失敗時にエラーメッセージが表示される
- [ ] スロット0への手動保存が禁止されている

### 2.4 ロード実行機能

**要件ID**: REQ-4.1-004

**EARS形式**:

- **EVENT-DRIVEN**: プレイヤーがセーブスロットを選択して「読み込み」ボタンを押したとき、システムは選択したスロットからゲーム状態を読み込まなければならない
- **EVENT-DRIVEN**: ロードを実行しようとしたとき、システムは「現在の進行状況が失われます」という警告と確認ダイアログを表示しなければならない
- **UBIQUITOUS**: 確認ダイアログには、「はい」「いいえ」の選択肢を表示しなければならない
- **EVENT-DRIVEN**: ロードが成功したとき、システムはロードしたデータに基づいて適切なシーン（章選択またはステージ選択）に遷移しなければならない
- **EVENT-DRIVEN**: ロードが失敗したとき、システムは「読み込み失敗」エラーメッセージを表示しなければならない
- **UNWANTED**: システムは、空のセーブスロットからのロードを許可してはならない

**受け入れ基準**:

- [ ] データありスロット選択→読み込みボタンでロードが実行される
- [ ] ロード前に確認ダイアログが表示される
- [ ] ロード成功時に適切なシーンに遷移する
- [ ] ロード失敗時にエラーメッセージが表示される
- [ ] 空スロットからのロードが禁止されている

### 2.5 セーブデータ削除機能

**要件ID**: REQ-4.1-005

**EARS形式**:

- **EVENT-DRIVEN**: プレイヤーがセーブスロットを選択して「削除」ボタンを押したとき、システムは削除確認ダイアログを表示しなければならない
- **UBIQUITOUS**: 削除確認ダイアログには、「本当に削除しますか？この操作は取り消せません」という警告を表示しなければならない
- **UBIQUITOUS**: 削除確認ダイアログには、「削除する」「キャンセル」の選択肢を表示しなければならない
- **EVENT-DRIVEN**: 削除が成功したとき、システムは「削除完了」メッセージを表示し、スロット一覧を更新しなければならない
- **EVENT-DRIVEN**: 削除が失敗したとき、システムは「削除失敗」エラーメッセージを表示しなければならない
- **UNWANTED**: システムは、空のセーブスロットの削除を許可してはならない
- **OPTIONAL**: システムは、スロット0（オートセーブ）の削除を許可してもよい

**受け入れ基準**:

- [ ] データありスロット選択→削除ボタンで削除確認が表示される
- [ ] 削除確認に警告メッセージが含まれる
- [ ] 削除成功時にスロット一覧が更新される
- [ ] 削除失敗時にエラーメッセージが表示される
- [ ] 空スロットの削除が禁止されている

### 2.6 オートセーブ設定機能

**要件ID**: REQ-4.1-006

**EARS形式**:

- **UBIQUITOUS**: システムは、セーブ・ロード画面にオートセーブの有効/無効を切り替えるトグルボタンを表示しなければならない
- **EVENT-DRIVEN**: プレイヤーがオートセーブトグルを切り替えたとき、システムは`SaveLoadManager.setAutoSaveEnabled()`を呼び出して設定を変更しなければならない
- **UBIQUITOUS**: システムは、現在のオートセーブ設定状態（有効/無効）を視覚的に明示しなければならない
- **EVENT-DRIVEN**: オートセーブ設定を変更したとき、システムは「設定を変更しました」というフィードバックを表示しなければならない

**受け入れ基準**:

- [ ] オートセーブトグルボタンが表示される
- [ ] トグルボタンで有効/無効を切り替えられる
- [ ] 現在の設定状態が視覚的に分かる
- [ ] 設定変更時にフィードバックが表示される

### 2.7 エラー表示機能

**要件ID**: REQ-4.1-007

**EARS形式**:

- **EVENT-DRIVEN**: セーブデータが破損していることを検出したとき、システムは「データ破損」エラーを表示しなければならない
- **EVENT-DRIVEN**: LocalStorageが利用できないことを検出したとき、システムは「ストレージ利用不可」エラーを表示しなければならない
- **EVENT-DRIVEN**: ストレージ容量が不足していることを検出したとき、システムは「容量不足」警告を表示しなければならない
- **UBIQUITOUS**: エラーメッセージには、問題の内容と推奨される対処法を含めなければならない
- **OPTIONAL**: システムは、破損したセーブデータの修復を試みてもよい

**受け入れ基準**:

- [ ] データ破損時に適切なエラーが表示される
- [ ] ストレージ利用不可時に適切なエラーが表示される
- [ ] 容量不足時に警告が表示される
- [ ] エラーメッセージに対処法が含まれる

### 2.8 キーボードナビゲーション

**要件ID**: REQ-4.1-008

**EARS形式**:

- **UBIQUITOUS**: システムは、矢印キー（↑↓）でセーブスロット間を移動できなければならない
- **UBIQUITOUS**: システムは、Enterキーで選択中のスロットに対するデフォルトアクション（保存または読み込み）を実行できなければならない
- **UBIQUITOUS**: システムは、Escキーでセーブ・ロード画面を閉じて前の画面に戻れなければならない
- **UBIQUITOUS**: システムは、Tabキーでボタン間（保存/読み込み/削除/戻る）を移動できなければならない
- **UBIQUITOUS**: システムは、現在フォーカスされている要素を視覚的に明示しなければならない

**受け入れ基準**:

- [ ] 矢印キーでスロット選択を移動できる
- [ ] Enterキーでアクションを実行できる
- [ ] Escキーで画面を閉じられる
- [ ] Tabキーでボタン間を移動できる
- [ ] フォーカス状態が視覚的に分かる

## 3. 非機能要件

### 3.1 パフォーマンス要件

**要件ID**: NFR-4.1-001

- **UBIQUITOUS**: システムは、セーブ・ロード画面を1秒以内に表示しなければならない
- **UBIQUITOUS**: システムは、セーブ操作を2秒以内に完了しなければならない
- **UBIQUITOUS**: システムは、ロード操作を3秒以内に完了しなければならない
- **UBIQUITOUS**: システムは、60fpsのフレームレートを維持しなければならない

### 3.2 ユーザビリティ要件

**要件ID**: NFR-4.1-002

- **UBIQUITOUS**: システムは、既存のシーン（TitleScene、ChapterSelectScene等）と一貫したUIデザインを使用しなければならない
- **UBIQUITOUS**: システムは、日本語でメッセージを表示しなければならない
- **UBIQUITOUS**: システムは、色覚異常のユーザーでも情報を識別できるよう、色だけでなく形状やテキストでも情報を伝えなければならない

### 3.3 互換性要件

**要件ID**: NFR-4.1-003

- **UBIQUITOUS**: システムは、既存の`SaveLoadManager` APIと完全に互換性がなければならない
- **UBIQUITOUS**: システムは、既存のシーン遷移システム（`SceneTransition`）を使用しなければならない
- **UBIQUITOUS**: システムは、既存のキーボードナビゲーションシステム（`KeyboardNavigationManager`）を使用しなければならない

### 3.4 保守性要件

**要件ID**: NFR-4.1-004

- **UBIQUITOUS**: システムは、TypeScriptの型安全性を活用しなければならない
- **UBIQUITOUS**: システムは、既存のコーディング規約に従わなければならない
- **UBIQUITOUS**: システムは、適切なエラーハンドリングとログ出力を実装しなければならない

## 4. 制約条件

### 4.1 技術的制約

- Phaser 3.88.2を使用
- TypeScriptで実装
- 既存の`SaveLoadManager`を変更しない
- LocalStorageの容量制限（通常5-10MB）に配慮

### 4.2 設計制約

- 既存のシーン構造に従う
- 既存のUIコンポーネント（`NavigableMenuButton`等）を再利用
- 既存のシーン遷移パターンに従う

## 5. 用語集

| 用語 | 定義 |
|------|------|
| セーブスロット | ゲーム進行状況を保存する10個の領域（スロット0-9） |
| オートセーブ | スロット0に自動的に保存される機能 |
| SaveLoadManager | セーブ・ロード機能を提供する既存のクラス |
| LocalStorage | ブラウザのローカルストレージAPI |
| セーブデータ | 章状態、ステージ進行、パーティ編成、プレイ時間を含むデータ |

## 6. 参照

- `.kiro/steering/3-wbs.md` - WBS（フェーズ4.1）
- `game/src/systems/chapterStage/SaveLoadManager.ts` - 既存実装
- `game/src/scenes/TitleScene.ts` - UIパターン参考
- `game/src/scenes/ChapterSelectScene.ts` - UIパターン参考
- `game/src/types/chapterStage.ts` - 型定義
