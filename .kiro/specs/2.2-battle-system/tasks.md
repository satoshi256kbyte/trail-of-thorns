# 実装計画

- [x] 1. 戦闘システムの基本データ構造と型定義を作成
  - game/src/types/battle.tsにBattleResult、DamageModifier、RangePattern等のインターフェースを定義
  - BattleError列挙型とエラーハンドリング用の型を実装
  - 武器データ構造（Weapon、WeaponType、WeaponEffect）を定義
  - 属性システム（Element）と戦闘関連の列挙型を作成
  - 型定義の妥当性検証とユニットテストを作成
  - _要件: 1.1, 3.1, 6.1_

- [x] 2. AttackRangeCalculatorクラスで攻撃範囲計算システムを実装
  - game/src/systems/AttackRangeCalculator.tsを作成し、武器種別ごとの攻撃範囲計算を実装
  - calculateAttackRange()メソッドで武器データに基づく範囲計算を実装
  - getWeaponRangePattern()メソッドで武器種別による範囲パターンを定義
  - isAttackBlocked()メソッドで障害物による攻撃阻害判定を実装
  - calculateAreaOfEffect()メソッドで範囲攻撃の影響範囲計算を実装
  - 攻撃範囲計算の精度と武器種別対応のユニットテストを作成
  - _要件: 1.1, 1.2, 1.3, 1.5_

- [x] 3. TargetSelectorクラスで攻撃対象選択システムを実装
  - game/src/systems/TargetSelector.tsを作成し、攻撃対象の選択と検証を実装
  - getValidTargets()メソッドで攻撃可能対象の特定を実装
  - selectTarget()メソッドで対象選択処理と検証を実装
  - getAreaTargets()メソッドで範囲攻撃対象の取得を実装
  - clearSelection()メソッドで対象選択のキャンセル処理を実装
  - 対象選択の妥当性と範囲攻撃対応のユニットテストを作成
  - _要件: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 4. DamageCalculatorクラスでダメージ計算システムを実装
  - game/src/systems/DamageCalculator.tsを作成し、包括的なダメージ計算を実装
  - calculateBaseDamage()メソッドで攻撃力と防御力に基づく基本ダメージ計算を実装
  - applyElementalModifier()メソッドで属性相性による倍率適用を実装
  - calculateCritical()メソッドでクリティカルヒット判定と倍率計算を実装
  - calculateEvasion()メソッドで回避判定システムを実装
  - calculateFinalDamage()メソッドで全修正値を適用した最終ダメージ計算を実装
  - ダメージ計算式の正確性と属性相性システムのユニットテストを作成
  - _要件: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 5. BattleAnimatorクラスで戦闘アニメーション・エフェクトシステムを実装
  - game/src/systems/BattleAnimator.tsを作成し、戦闘の視覚的演出を実装
  - playAttackAnimation()メソッドで攻撃者の攻撃アニメーション再生を実装
  - showDamageEffect()メソッドでダメージエフェクトとダメージ数値表示を実装
  - animateHPChange()メソッドでHPバーの減少アニメーションを実装
  - playDefeatedAnimation()メソッドで戦闘不能演出を実装
  - clearBattleEffects()メソッドでエフェクトのクリーンアップを実装
  - アニメーション再生とタイミング制御のユニットテストを作成
  - _要件: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 6. BattleStateManagerクラスで戦闘状態管理システムを実装
  - game/src/systems/BattleStateManager.tsを作成し、戦闘中の状態変更を管理
  - applyDamage()メソッドでキャラクターへのダメージ適用と現在HP更新を実装
  - handleUnitDefeated()メソッドで戦闘不能状態の処理と行動無効化を実装
  - grantExperience()メソッドで攻撃者への経験値付与システムを実装
  - recordBattleResult()メソッドで戦闘結果の記録と統計管理を実装
  - updatePostBattle()メソッドで戦闘終了後のゲーム状態更新を実装
  - 状態変更の整合性と経験値付与システムのユニットテストを作成
  - _要件: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 7. BattleSystemメインコントローラークラスを実装
  - game/src/systems/BattleSystem.tsを作成し、戦闘フロー全体を統括
  - initiateAttack()メソッドで攻撃フローの開始と初期化を実装
  - showAttackRange()メソッドで攻撃範囲の視覚表示を実装
  - selectTarget()メソッドで攻撃対象選択から戦闘実行までの統合処理を実装
  - cancelAttack()メソッドで攻撃のキャンセルと状態リセットを実装
  - canAttack()メソッドで戦闘可能性の総合判定を実装
  - 戦闘フロー全体の統合テストと各サブシステム連携のテストを作成
  - _要件: 1.1, 2.1, 3.1, 4.1, 5.1_

- [x] 8. 武器・装備システムとの連携機能を実装
  - 既存のキャラクターデータ構造に武器・装備情報を統合
  - 武器データのJSON読み込みとバリデーション機能を実装
  - 装備による攻撃力・防御力・属性の戦闘計算への適用を実装
  - 武器の特殊効果（状態異常付与等）の戦闘システム統合を実装
  - 装備破損状態の性能低下システムを実装
  - 武器・装備データの整合性と戦闘計算への影響のユニットテストを作成
  - _要件: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 9. 戦闘システムのUI統合とビジュアルフィードバックを実装
  - 攻撃範囲ハイライト表示をMapRendererに統合
  - 攻撃対象選択時の視覚的フィードバックUI実装
  - ダメージ数値表示とHPバー更新のUI統合
  - 戦闘結果表示（経験値獲得、レベルアップ等）のUI実装
  - 戦闘エラー時のユーザー通知システム実装
  - UI表示とユーザーインタラクションの統合テストを作成
  - _要件: 1.1, 2.2, 4.2, 4.3, 5.4_

- [x] 10. GameplaySceneとの統合と入力処理システムを実装
  - GameplaySceneに戦闘システムを統合し、ターン制システムと連携
  - マウスクリックによる攻撃開始と対象選択の入力処理を実装
  - キーボードショートカットによる戦闘コマンド（攻撃、キャンセル等）を実装
  - 戦闘中の他システム（移動、メニュー等）との排他制御を実装
  - 戦闘完了後のターン進行とゲーム状態更新を実装
  - GameplayScene統合の完全なワークフローテストを作成
  - _要件: 1.1, 2.1, 4.5, 5.4_

- [x] 11. エラーハンドリングとユーザーフィードバックシステムを実装
  - BattleErrorHandlerクラスで戦闘エラーの分類と処理を実装
  - 各種戦闘エラー（無効な攻撃者、射程外等）の検出と回復処理を実装
  - エラー発生時のユーザー通知とガイダンス表示を実装
  - 戦闘中断時の状態復旧とクリーンアップ処理を実装
  - 戦闘システムの堅牢性向上とユーザビリティ改善を実装
  - エラーシナリオと回復メカニズムの包括的テストを作成
  - _要件: 2.5, 5.1, 全要件のエラーハンドリング_

- [x] 12. パフォーマンス最適化とメモリ管理を実装
  - 攻撃範囲計算の結果キャッシュシステムを実装
  - 戦闘アニメーション・エフェクトのオブジェクトプール管理を実装
  - 大規模戦闘時のパフォーマンス監視と最適化を実装
  - メモリリーク防止のための適切なリソース解放処理を実装
  - 戦闘システムのスケーラビリティ向上を実装
  - パフォーマンステストとメモリ使用量監視のテストを作成
  - _要件: 全要件のパフォーマンス要求_

- [x] 13. 戦闘システム設定とデバッグツールを実装
  - GameConfigに戦闘システムの設定オプション（ダメージ倍率、アニメーション速度等）を追加
  - 開発用の戦闘シミュレーション・デバッグ機能を実装
  - 戦闘計算の詳細ログ出力とデバッグ表示を実装
  - コンソールコマンドによる戦闘テスト機能を実装
  - 戦闘バランス調整用のツールと統計機能を実装
  - デバッグ機能とバランス調整ツールのテストを作成
  - _要件: 全要件の設定可能性とデバッグ支援_

- [x] 14. 包括的テストスイートと品質保証を実装
  - 戦闘システム全体の統合テストスイートを作成
  - エンドツーエンドの戦闘ワークフローテストを実装
  - 戦闘アニメーションと状態同期のビジュアル回帰テストを実装
  - 戦闘システムのパフォーマンスベンチマークテストを実装
  - アクセシビリティ対応（キーボード操作、視覚的フィードバック）のテストを実装
  - 全要件カバレッジの確認と品質保証テストを作成
  - _要件: 全要件の包括的テストカバレッジ_
