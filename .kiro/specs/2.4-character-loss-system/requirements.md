# キャラクターロストシステム 要件定義書

## 概要

「魔性の薔薇」の世界観における戦略性の核となるキャラクターロストシステムを実装します。このシステムでは、敵の攻撃で味方キャラクターが撃破されると、その章内では使用不可となり、章クリア時にロスト状態がリセットされます。これにより、プレイヤーに緊張感のある戦略的判断を求めるとともに、キャラクターの価値を高めます。

## 要件

### 要件1: 章内キャラクター状態管理

**ユーザーストーリー:** ゲーム管理者として、各章内でのキャラクターの生存・ロスト状態を正確に管理したい。そうすることで、章内でのキャラクター使用可否を適切に制御できる。

#### 受入基準

1. WHEN 章が開始される THEN システム SHALL 全キャラクターのロスト状態を初期化する
2. WHEN キャラクターが撃破される THEN システム SHALL そのキャラクターを章内ロスト状態に設定する
3. WHEN 章内ロスト状態のキャラクターが存在する THEN システム SHALL そのキャラクターの使用を禁止する
4. WHEN 章がクリアされる THEN システム SHALL 全キャラクターのロスト状態をリセットする
5. IF キャラクターが章内ロスト状態である THEN システム SHALL パーティ編成でそのキャラクターを選択不可にする

### 要件2: ロスト発生処理

**ユーザーストーリー:** プレイヤーとして、キャラクターが撃破された時に明確にロスト状態になったことを理解したい。そうすることで、戦略的な判断を適切に行える。

#### 受入基準

1. WHEN キャラクターのHPが0になる THEN システム SHALL ロスト発生処理を実行する
2. WHEN ロスト発生処理が実行される THEN システム SHALL キャラクターロスト演出を表示する
3. WHEN ロスト演出が完了する THEN システム SHALL キャラクターをマップから除去する
4. WHEN キャラクターがロストする THEN システム SHALL ロスト状態をゲーム状態に記録する
5. IF 仲間化されたNPCがロストする THEN システム SHALL 仲間化状態も同時に失効させる

### 要件3: ロスト状態の視覚表現

**ユーザーストーリー:** プレイヤーとして、どのキャラクターがロスト状態なのかを視覚的に明確に把握したい。そうすることで、現在の戦力を正確に認識できる。

#### 受入基準

1. WHEN パーティ編成画面を表示する THEN システム SHALL ロストキャラクターをグレーアウト表示する
2. WHEN ロストキャラクターを選択しようとする THEN システム SHALL 選択不可の視覚フィードバックを表示する
3. WHEN ロストキャラクターにカーソルを合わせる THEN システム SHALL 「章内使用不可」の説明を表示する
4. WHEN ステージ選択画面を表示する THEN システム SHALL 現在のロストキャラクター数を表示する
5. IF 複数のキャラクターがロスト状態である THEN システム SHALL ロストキャラクター一覧を表示する

### 要件4: ロスト警告システム

**ユーザーストーリー:** プレイヤーとして、キャラクターがロストの危険にある時に事前に警告を受けたい。そうすることで、重要なキャラクターを失うリスクを回避できる。

#### 受入基準

1. WHEN キャラクターのHPが25%以下になる THEN システム SHALL 危険状態の視覚表示を行う
2. WHEN 危険状態のキャラクターが攻撃対象になる THEN システム SHALL ロスト警告UIを表示する
3. WHEN プレイヤーが危険な行動を取ろうとする THEN システム SHALL 確認ダイアログを表示する
4. WHEN 確認ダイアログが表示される THEN プレイヤー SHALL 行動の続行または中止を選択できる
5. IF 重要なキャラクター（主人公等）が危険状態になる THEN システム SHALL 特別な警告を表示する

### 要件5: 章クリア時のロスト状態表示

**ユーザーストーリー:** プレイヤーとして、章クリア時にロストしたキャラクターの情報を確認したい。そうすることで、次章への戦略を立てることができる。

#### 受入基準

1. WHEN 章がクリアされる THEN システム SHALL 章クリア結果画面を表示する
2. WHEN 章クリア結果画面が表示される THEN システム SHALL ロストしたキャラクター一覧を表示する
3. WHEN ロストキャラクター一覧が表示される THEN システム SHALL 各キャラクターのロスト原因を表示する
4. WHEN 章クリア結果を確認後 THEN システム SHALL 全キャラクターのロスト状態をリセットする
5. IF 章内でロストしたキャラクターがいない THEN システム SHALL 「全員生存」のメッセージを表示する

### 要件6: パーティ編成でのロスト制御

**ユーザーストーリー:** プレイヤーとして、パーティ編成時にロストキャラクターを誤って選択することなく、利用可能なキャラクターのみで編成したい。そうすることで、スムーズにゲームを進行できる。

#### 受入基準

1. WHEN パーティ編成画面を開く THEN システム SHALL ロストキャラクターを選択不可状態で表示する
2. WHEN ロストキャラクターをクリックする THEN システム SHALL 選択不可の理由を表示する
3. WHEN パーティ編成を確定する THEN システム SHALL ロストキャラクターが含まれていないことを検証する
4. WHEN 編成検証でエラーが発生する THEN システム SHALL エラーメッセージと修正方法を表示する
5. IF 利用可能なキャラクターが不足する THEN システム SHALL 警告メッセージを表示する

### 要件7: データ永続化とセーブ連携

**ユーザーストーリー:** プレイヤーとして、ゲームを中断・再開した時にロスト状態が正確に保持されていることを期待する。そうすることで、安心してゲームを進行できる。

#### 受入基準

1. WHEN ゲームをセーブする THEN システム SHALL 現在のロスト状態をセーブデータに記録する
2. WHEN ゲームをロードする THEN システム SHALL セーブデータからロスト状態を復元する
3. WHEN 章の途中でゲームを終了する THEN システム SHALL ロスト状態を一時保存する
4. WHEN 章の途中からゲームを再開する THEN システム SHALL 一時保存されたロスト状態を復元する
5. IF セーブデータが破損している THEN システム SHALL デフォルト状態（全員生存）で開始する

### 要件8: 戦闘システムとの統合

**ユーザーストーリー:** 開発者として、既存の戦闘システムとキャラクターロストシステムが適切に連携することを確認したい。そうすることで、一貫したゲーム体験を提供できる。

#### 受入基準

1. WHEN 戦闘でキャラクターが撃破される THEN 戦闘システム SHALL ロストシステムに通知する
2. WHEN ロストシステムが通知を受ける THEN システム SHALL ロスト処理を実行する
3. WHEN ロスト処理が完了する THEN システム SHALL 戦闘システムに完了を通知する
4. WHEN 戦闘が終了する THEN システム SHALL ロスト状態を戦闘結果に反映する
5. IF 全キャラクターがロストする THEN システム SHALL ゲームオーバー処理を実行する

### 要件9: UI/UXの一貫性

**ユーザーストーリー:** プレイヤーとして、ロスト関連のUI要素が他のゲーム要素と一貫したデザインで表示されることを期待する。そうすることで、直感的にシステムを理解できる。

#### 受入基準

1. WHEN ロスト関連UIを表示する THEN システム SHALL 既存のUIデザインガイドラインに従う
2. WHEN ロスト状態を表現する THEN システム SHALL 統一された色彩・アイコンを使用する
3. WHEN ロスト警告を表示する THEN システム SHALL 適切な優先度レベルで表示する
4. WHEN ロスト情報を表示する THEN システム SHALL 読みやすいフォントとサイズを使用する
5. IF 複数のロスト関連UI要素が同時表示される THEN システム SHALL 適切な階層構造で表示する

### 要件10: パフォーマンスと最適化

**ユーザーストーリー:** 開発者として、キャラクターロストシステムがゲーム全体のパフォーマンスに悪影響を与えないことを確認したい。そうすることで、スムーズなゲーム体験を維持できる。

#### 受入基準

1. WHEN ロスト状態チェックを実行する THEN システム SHALL 1ms以内で処理を完了する
2. WHEN ロスト演出を表示する THEN システム SHALL 60fpsを維持する
3. WHEN 大量のキャラクターデータを処理する THEN システム SHALL メモリ使用量を最適化する
4. WHEN ロスト状態を保存・復元する THEN システム SHALL 高速なシリアライゼーションを使用する
5. IF システムリソースが不足する THEN システム SHALL 適切にエラーハンドリングを行う
