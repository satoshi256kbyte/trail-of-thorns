# 実装計画

キャラクターロストシステムの設計を、テスト駆動開発で段階的に実装するためのタスクリストです。各タスクは独立して実装・テスト可能で、前のタスクの成果物を活用して次のタスクを進めます。

- [x] 1. キャラクターロストシステムの基本データ構造と型定義を作成
  - LostCharacter、LossCause、ChapterLossSummary等の型定義を実装
  - ロスト状態を表現するenum（DangerLevel、LossCauseType等）を定義
  - データ永続化用のシリアライゼーション構造を設計
  - 基本的な型定義のユニットテストを作成
  - _要件: 1.1, 2.1, 7.1_

- [x] 2. CharacterLossStateクラスで章内キャラクター状態管理システムを実装
  - 章開始時の状態初期化機能を実装
  - キャラクターロスト時の状態記録機能を実装
  - ロスト状態の判定機能を実装
  - 章クリア時の状態リセット機能を実装
  - 状態管理のユニットテストを作成
  - _要件: 1.1, 1.2, 1.4, 7.3_

- [x] 3. CharacterLossManagerクラスでロスト発生処理システムを実装
  - キャラクター撃破時のロスト処理メインフローを実装
  - ロスト原因の分析と記録機能を実装
  - 仲間化システムとの連携（NPC撃破時の処理）を実装
  - ゲーム状態への反映機能を実装
  - ロスト処理のユニットテストを作成
  - _要件: 2.1, 2.2, 2.4, 8.1, 8.2_

- [x] 4. CharacterLossEffectsクラスでロスト演出システムを実装
  - キャラクターロスト時のアニメーション効果を実装
  - 原因別の特殊演出（戦闘撃破、クリティカル等）を実装
  - フェードアウト効果とロストメッセージ表示を実装
  - 危険状態の視覚エフェクト（パーティクル等）を実装
  - 演出システムのユニットテストを作成
  - _要件: 2.2, 2.3, 4.1, 4.2_

- [x] 5. 危険状態警告システムを実装
  - キャラクターの危険度判定ロジック（HP25%以下等）を実装
  - 危険状態の視覚的警告表示を実装
  - プレイヤー行動時の確認ダイアログシステムを実装
  - 重要キャラクター（主人公等）の特別警告を実装
  - 警告システムのユニットテストを作成
  - _要件: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 6. CharacterLossUIクラスでロスト状態の視覚表現システムを実装
  - パーティ編成画面でのロストキャラクターグレーアウト表示を実装
  - ロストキャラクター選択時の不可フィードバックを実装
  - ロスト理由の説明表示機能を実装
  - ステージ選択画面でのロストキャラクター数表示を実装
  - UI表示システムのユニットテストを作成
  - _要件: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 7. パーティ編成システムとの統合機能を実装
  - ロストキャラクターの選択不可制御を実装
  - パーティ編成時の検証システムを実装
  - 利用可能キャラクター不足時の警告表示を実装
  - 編成エラー時の修正方法提示を実装
  - パーティ編成統合のユニットテストを作成
  - _要件: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 8. 戦闘システムとの統合機能を実装
  - BattleSystemからのロスト通知受信機能を実装
  - ロスト処理完了の戦闘システムへの通知機能を実装
  - 戦闘結果へのロスト状態反映機能を実装
  - 全キャラクターロスト時のゲームオーバー処理を実装
  - 戦闘システム統合のユニットテストを作成
  - _要件: 8.1, 8.2, 8.3, 8.4, 8.5_

- [x] 9. 章完了時のロスト状態表示システムを実装
  - 章クリア結果画面でのロストキャラクター一覧表示を実装
  - 各キャラクターのロスト原因表示を実装
  - 全員生存時の「パーフェクトクリア」表示を実装
  - 章完了後の状態リセット処理を実装
  - 章完了UI表示のユニットテストを作成
  - _要件: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 10. データ永続化とセーブ・ロード連携機能を実装
  - ロスト状態のセーブデータへの記録機能を実装
  - セーブデータからのロスト状態復元機能を実装
  - 章途中でのゲーム中断・再開時の状態保持を実装
  - セーブデータ破損時のデフォルト状態復旧を実装
  - データ永続化のユニットテストを作成
  - _要件: 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 11. エラーハンドリングとユーザーフィードバックシステムを実装
  - 無効なキャラクターでのロスト処理エラーハンドリングを実装
  - 既にロスト状態のキャラクターへの重複処理防止を実装
  - セーブデータ破損時の復旧処理を実装
  - ユーザーへの適切なエラーメッセージ表示を実装
  - エラーハンドリングのユニットテストを作成
  - _要件: システム安定性、データ整合性_

- [x] 12. パフォーマンス最適化とメモリ管理を実装
  - ロスト状態チェックの高速化（1ms以内の処理時間）を実装
  - ロスト演出の60fps維持最適化を実装
  - メモリ使用量の最適化（目標20KB以下）を実装
  - エフェクトオブジェクトの適切な破棄処理を実装
  - パフォーマンステストを作成
  - _要件: 10.1, 10.2, 10.3, 10.4, 10.5_

- [ ] 13. UI/UXの一貫性とデザインガイドライン適用を実装
  - 既存UIデザインガイドラインに準拠したロスト関連UI実装
  - 統一された色彩・アイコンでのロスト状態表現を実装
  - 適切な優先度レベルでの警告表示を実装
  - 読みやすいフォントとサイズでの情報表示を実装
  - UI/UX一貫性のテストを作成
  - _要件: 9.1, 9.2, 9.3, 9.4, 9.5_

- [ ] 14. 包括的テストスイートと品質保証を実装
  - 完全なロストフロー（撃破→ロスト→章完了→リセット）のE2Eテストを作成
  - 警告システム（危険状態→警告表示→プレイヤー判断）のE2Eテストを作成
  - 複数キャラクター同時ロストのテストケースを作成
  - パーティ編成制限のテストケースを作成
  - 統合テストとリグレッションテストを作成
  - _要件: 全要件の統合検証_
