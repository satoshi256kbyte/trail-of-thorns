# 要件定義書

## はじめに

本書は「Trail of Thorns」における章・ステージ管理システムの要件を定義します。このシステムは、4-24ステージで構成される章の進行管理、最大6人のパーティ編成、ステージ解放条件の管理など、ゲーム進行の基盤となる機能を提供します。

## 用語集

- **Chapter（章）**: 4-24のステージで構成されるゲームの大きな区切り
- **Stage（ステージ）**: 個別の戦闘マップとシナリオで構成される単位
- **Party（パーティ）**: ステージに参加する最大6人の味方キャラクターグループ
- **ChapterManager（章管理システム）**: 章の進行状況とキャラクター状態を管理するシステム
- **PartyManager（パーティ管理システム）**: パーティ編成とバリデーションを管理するシステム
- **StageProgressManager（ステージ進行管理システム）**: ステージの解放条件と進行状況を管理するシステム
- **LostCharacter（ロストキャラクター）**: 章内で撃破され使用不可となったキャラクター
- **ChapterState（章状態）**: 現在の章の進行状況とキャラクター状態の集合
- **StageUnlockCondition（ステージ解放条件）**: ステージをプレイ可能にするための条件

## 要件

### 要件1: 章管理システム

**ユーザーストーリー:** ゲーム開発者として、章の進行状況とキャラクター状態を一元管理したい。これにより、プレイヤーの進行状況を正確に追跡し、章間でのキャラクター状態を適切に管理できる。

#### 受入基準

1. WHEN 新しい章を開始する THEN THE ChapterManager SHALL 章データを初期化し、利用可能なキャラクターリストを設定する
2. WHEN 章内でキャラクターがロストする THEN THE ChapterManager SHALL そのキャラクターを章内使用不可リストに追加し、パーティから除外する
3. WHEN 章をクリアする THEN THE ChapterManager SHALL 章の完了状態を記録し、次章でキャラクター状態をリセットする
4. WHEN 章の進行状況を保存する THEN THE ChapterManager SHALL 現在のステージ、ロストキャラクター、パーティ編成を含む章状態を永続化する
5. WHEN 章の進行状況を読み込む THEN THE ChapterManager SHALL 保存された章状態を復元し、ゲーム状態を正確に再現する

### 要件2: パーティ編成システム

**ユーザーストーリー:** プレイヤーとして、ステージに参加する最大6人のキャラクターを選択したい。これにより、戦略的なパーティ編成を行い、各ステージに最適な構成で挑戦できる。

#### 受入基準

1. WHEN パーティにキャラクターを追加する THEN THE PartyManager SHALL パーティサイズが6人以下であることを検証し、追加を許可または拒否する
2. WHEN ロストキャラクターをパーティに追加しようとする THEN THE PartyManager SHALL 追加を拒否し、エラーメッセージを表示する
3. WHEN パーティからキャラクターを除外する THEN THE PartyManager SHALL キャラクターをパーティから削除し、編成を更新する
4. WHEN パーティ編成を検証する THEN THE PartyManager SHALL 全てのキャラクターが利用可能であり、重複がないことを確認する
5. WHEN パーティ編成UIを表示する THEN THE System SHALL 利用可能なキャラクター、ロストキャラクター、現在のパーティを明確に区別して表示する

### 要件3: ステージ進行管理システム

**ユーザーストーリー:** プレイヤーとして、クリアしたステージに応じて新しいステージが解放されることを期待する。これにより、段階的にゲームを進行し、達成感を得られる。

#### 受入基準

1. WHEN ステージをクリアする THEN THE StageProgressManager SHALL ステージのクリア状態を記録し、次のステージを解放する
2. WHEN ステージ選択画面を表示する THEN THE System SHALL 解放済みステージ、未解放ステージ、クリア済みステージを視覚的に区別して表示する
3. WHEN 未解放ステージを選択しようとする THEN THE System SHALL 選択を拒否し、解放条件を表示する
4. WHEN 章の全ステージをクリアする THEN THE StageProgressManager SHALL 章完了状態を記録し、次章を解放する
5. WHEN 進行状況を保存する THEN THE StageProgressManager SHALL 全ステージのクリア状態、解放状態、獲得報酬を永続化する

### 要件4: 章間キャラクター状態管理

**ユーザーストーリー:** プレイヤーとして、章が変わるとロストキャラクターが復活することを期待する。これにより、新しい章で再び全キャラクターを使用できる。

#### 受入基準

1. WHEN 新しい章を開始する THEN THE ChapterManager SHALL 前章のロスト状態をクリアし、全キャラクターを利用可能にする
2. WHEN 章内でキャラクターがロストする THEN THE System SHALL ロスト状態を章内でのみ保持し、章完了後にリセットする
3. WHEN 章を途中で中断する THEN THE System SHALL ロスト状態を保存し、再開時に復元する
4. WHEN 章完了画面を表示する THEN THE System SHALL ロストしたキャラクターのリストと、次章での復活を通知する

### 要件5: データ永続化とセーブ・ロード連携

**ユーザーストーリー:** プレイヤーとして、ゲームを中断して後で続きから再開したい。これにより、長時間のプレイを複数のセッションに分けて楽しめる。

#### 受入基準

1. WHEN ゲームを保存する THEN THE System SHALL 現在の章、ステージ、パーティ編成、ロスト状態を含む完全な進行状況を保存する
2. WHEN セーブデータを読み込む THEN THE System SHALL 保存された進行状況を復元し、正確なゲーム状態を再現する
3. WHEN セーブデータが破損している THEN THE System SHALL エラーを検出し、適切なエラーメッセージを表示する
4. WHEN 複数のセーブスロットが存在する THEN THE System SHALL 各スロットの章、ステージ、プレイ時間を表示する
5. WHEN オートセーブが有効な THEN THE System SHALL ステージクリア時、章完了時に自動的に進行状況を保存する

### 要件6: ステージ選択UI

**ユーザーストーリー:** プレイヤーとして、直感的なUIで次にプレイするステージを選択したい。これにより、スムーズにゲームを進行できる。

#### 受入基準

1. WHEN ステージ選択画面を表示する THEN THE System SHALL 章内の全ステージをリスト形式またはマップ形式で表示する
2. WHEN 解放済みステージにカーソルを合わせる THEN THE System SHALL ステージ名、難易度、推奨レベル、クリア状態を表示する
3. WHEN 未解放ステージにカーソルを合わせる THEN THE System SHALL 解放条件と必要なクリアステージを表示する
4. WHEN ステージを選択する THEN THE System SHALL パーティ編成画面に遷移し、編成確認後にステージを開始する
5. WHEN ステージ選択画面でキャンセルする THEN THE System SHALL 章選択画面またはタイトル画面に戻る

### 要件7: パーティ編成UI

**ユーザーストーリー:** プレイヤーとして、視覚的にわかりやすいUIでパーティを編成したい。これにより、効率的に戦略的な編成を行える。

#### 受入基準

1. WHEN パーティ編成画面を表示する THEN THE System SHALL 現在のパーティ（最大6枠）、利用可能なキャラクターリスト、ロストキャラクターリストを表示する
2. WHEN 利用可能なキャラクターを選択する THEN THE System SHALL キャラクターの詳細情報（レベル、職業、ステータス、スキル）を表示する
3. WHEN キャラクターをパーティに追加する THEN THE System SHALL 空いている枠にキャラクターを配置し、視覚的フィードバックを提供する
4. WHEN パーティが満員の状態でキャラクターを追加しようとする THEN THE System SHALL 追加を拒否し、「パーティが満員です」というメッセージを表示する
5. WHEN ロストキャラクターを選択しようとする THEN THE System SHALL 選択を拒否し、「このキャラクターは章内で使用不可です」というメッセージを表示する
6. WHEN パーティ編成を確定する THEN THE System SHALL 編成を保存し、ステージ開始画面に遷移する

### 要件8: 章選択システム

**ユーザーストーリー:** プレイヤーとして、プレイする章を選択したい。これにより、ストーリーの進行に応じて新しい章に挑戦できる。

#### 受入基準

1. WHEN 章選択画面を表示する THEN THE System SHALL 解放済みの章をリスト形式で表示する
2. WHEN 章を選択する THEN THE System SHALL 章の概要、ステージ数、推奨レベル、ストーリー概要を表示する
3. WHEN 章を開始する THEN THE System SHALL 章データを初期化し、ステージ選択画面に遷移する
4. WHEN 未解放の章を選択しようとする THEN THE System SHALL 選択を拒否し、解放条件を表示する
5. WHEN 進行中の章が存在する THEN THE System SHALL 「続きから」オプションを表示し、中断した位置から再開できるようにする

### 要件9: エラーハンドリングとユーザーフィードバック

**ユーザーストーリー:** プレイヤーとして、システムエラーが発生した場合に適切な通知を受け取りたい。これにより、問題を理解し、適切に対処できる。

#### 受入基準

1. WHEN データ読み込みエラーが発生する THEN THE System SHALL エラーメッセージを表示し、タイトル画面に戻る
2. WHEN 無効なパーティ編成を検出する THEN THE System SHALL 具体的な問題（満員、ロストキャラクター等）を説明するメッセージを表示する
3. WHEN ステージ解放条件を満たしていない THEN THE System SHALL 必要な条件を明確に表示する
4. WHEN セーブデータの保存に失敗する THEN THE System SHALL エラーを通知し、再試行オプションを提供する
5. WHEN システムエラーが発生する THEN THE System SHALL エラーログを記録し、開発者が問題を診断できるようにする

### 要件10: パフォーマンスとメモリ管理

**ユーザーストーリー:** プレイヤーとして、章・ステージ管理システムが軽快に動作することを期待する。これにより、ストレスなくゲームを進行できる。

#### 受入基準

1. WHEN ステージ選択画面を表示する THEN THE System SHALL 1秒以内に全ステージ情報を読み込み、表示する
2. WHEN パーティ編成画面を表示する THEN THE System SHALL 0.5秒以内にキャラクターリストを表示する
3. WHEN 章を切り替える THEN THE System SHALL 前章のデータを適切にクリーンアップし、メモリリークを防ぐ
4. WHEN 大量のステージデータを管理する THEN THE System SHALL 必要なデータのみをメモリに保持し、効率的に管理する
5. WHEN 進行状況を保存する THEN THE System SHALL 2秒以内に保存処理を完了する

